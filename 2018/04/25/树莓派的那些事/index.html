<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.1.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.1.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="引言树莓派入手很久了，一直搁置在那也没怎么用，最近突发奇想就拿来重新刷了系统，遇到了很多问题，故简单地记录一下。 安装系统本次选择了官方系统的Lite版，基于Debian，我使用的版本是2018年4月18日更新的，其他版本其实应该都大同小异，但据了解Lite版和Desktop版差别挺大的。还是给个传送门吧。刷入系统我选择的是官方推荐的ETCher，界面十分简约，功能也十分简约，就是专门用来干这个的">
<meta name="keywords" content="树莓派,Debian">
<meta property="og:type" content="article">
<meta property="og:title" content="树莓派的那些事">
<meta property="og:url" content="https://hexo.xinsane.com/2018/04/25/树莓派的那些事/index.html">
<meta property="og:site_name" content="梦的天空之城">
<meta property="og:description" content="引言树莓派入手很久了，一直搁置在那也没怎么用，最近突发奇想就拿来重新刷了系统，遇到了很多问题，故简单地记录一下。 安装系统本次选择了官方系统的Lite版，基于Debian，我使用的版本是2018年4月18日更新的，其他版本其实应该都大同小异，但据了解Lite版和Desktop版差别挺大的。还是给个传送门吧。刷入系统我选择的是官方推荐的ETCher，界面十分简约，功能也十分简约，就是专门用来干这个的">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-04-25T17:05:45.018Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="树莓派的那些事">
<meta name="twitter:description" content="引言树莓派入手很久了，一直搁置在那也没怎么用，最近突发奇想就拿来重新刷了系统，遇到了很多问题，故简单地记录一下。 安装系统本次选择了官方系统的Lite版，基于Debian，我使用的版本是2018年4月18日更新的，其他版本其实应该都大同小异，但据了解Lite版和Desktop版差别挺大的。还是给个传送门吧。刷入系统我选择的是官方推荐的ETCher，界面十分简约，功能也十分简约，就是专门用来干这个的">






  <link rel="canonical" href="https://hexo.xinsane.com/2018/04/25/树莓派的那些事/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>树莓派的那些事 | 梦的天空之城</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">梦的天空之城</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  
  <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
</li>

      
        
        
          
  
  <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
</li>

      
        
        
          
  
  <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
</li>

      
        
        
          
  
  <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
</li>

      
        
        
          
  
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
</li>

      

      
    </ul>
  

  
    

    
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
    

  


  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hexo.xinsane.com/2018/04/25/树莓派的那些事/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xinsane">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="梦的天空之城">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">树莓派的那些事</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-25T17:28:37+08:00">2018-04-25</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/树莓派/" itemprop="url" rel="index"><span itemprop="name">树莓派</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/25/树莓派的那些事/" class="leancloud_visitors" data-flag-title="树莓派的那些事">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>树莓派入手很久了，一直搁置在那也没怎么用，最近突发奇想就拿来重新刷了系统，遇到了很多问题，故简单地记录一下。</p>
<h2 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h2><p>本次选择了官方系统的Lite版，基于Debian，我使用的版本是2018年4月18日更新的，其他版本其实应该都大同小异，但据了解Lite版和Desktop版差别挺大的。<a href="https://www.raspberrypi.org/downloads/raspbian/" target="_blank" rel="noopener">还是给个传送门吧</a>。刷入系统我选择的是官方推荐的ETCher，界面十分简约，功能也十分简约，就是专门用来干这个的，当然其他的刷入工具也是可以的。</p>
<h2 id="开启ssh"><a href="#开启ssh" class="headerlink" title="开启ssh"></a>开启ssh</h2><p>其实这个系统默认就是有安装好ssh，只是默认没有开启而已。<br>启动ssh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /etc/init.d/ssh start</span><br></pre></td></tr></table></figure></p>
<p>或者配置开机自启后再启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable ssh</span><br><span class="line">sudo systemctl start ssh</span><br></pre></td></tr></table></figure></p>
<p>然后就可以用电脑通过ssh访问了<br>顺便记录一下，官方系统默认帐号是pi，默认密码是raspberry<br>ssh连接之前记得查看一下树莓派的ip地址<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig</span><br></pre></td></tr></table></figure></p>
<p>我用路由器给我的树莓派绑定了固定ip地址，或者可以在树莓派里配置静态ip，具体方法不再赘述。</p>
<h3 id="禁止密码登陆ssh"><a href="#禁止密码登陆ssh" class="headerlink" title="禁止密码登陆ssh"></a>禁止密码登陆ssh</h3><p>首先修改默认用户密码，以免被别人趁虚而入。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd</span><br></pre></td></tr></table></figure></p>
<p>然后建立.ssh目录上传公钥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir .ssh</span><br><span class="line">cd .ssh</span><br><span class="line">nano authorized_keys</span><br></pre></td></tr></table></figure></p>
<p>然后粘贴公钥，<strong>Ctrl+O</strong> 保存，<strong>Ctrl+X</strong> 退出nano（使用其他编辑器比如vi也可以，我习惯用nano，后面的编辑都会用这个编辑器），然后退出shell尝试使用密钥登陆，如果能登陆成功，就可以禁止密码登陆了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure></p>
<p>找到PasswordAuthentication这一项<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#PasswordAuthentication yes</span><br></pre></td></tr></table></figure></p>
<p>取消注释并改成no<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PasswordAuthentication no</span><br></pre></td></tr></table></figure></p>
<p>然后保存退出，重启ssh服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart ssh</span><br></pre></td></tr></table></figure></p>
<p>然后退出shell，再登陆时就只能用密钥登陆了</p>
<h2 id="换源-or-代理？"><a href="#换源-or-代理？" class="headerlink" title="换源 or 代理？"></a>换源 or 代理？</h2><p>树莓派的官方源在境外，国内访问会比较慢，网上的说法比较倾向于换源，这也确实是一个很不错的方法。但是在实际的使用中，一定要确认使用的源是否正确。我开始换了阿里的源，速度确实非常快，但是很多包安装不了，大部分报情况下显示，可能请求了一个不稳定版的软件并且缺少一些依赖，这种情况下无法自动安装依赖（正常情况下安装一个软件缺少依赖时会自动安装），网上可以通过列出所有的依赖然后依次安装的方法解决这个问题，但是我发现只要换回了官方源就不会有这个问题。同时国内的源跟官方源不匹配也是一个问题，有时候国内会更新的慢很多，所以在换源的时候一定要小心了。最后我还是决定使用代理的方式来解决速度慢的问题（理论上使用代理网络请求，请求同样是要出境，但经过实际测试使用代理就是会比正常访问快很多，我也没有具体研究原因）。</p>
<h3 id="使用-shadowsocks-libev-privoxy-实现自由命令行代理"><a href="#使用-shadowsocks-libev-privoxy-实现自由命令行代理" class="headerlink" title="使用 shadowsocks-libev + privoxy 实现自由命令行代理"></a>使用 shadowsocks-libev + privoxy 实现自由命令行代理</h3><h4 id="安装-shadowsocks-libev"><a href="#安装-shadowsocks-libev" class="headerlink" title="安装 shadowsocks-libev"></a>安装 shadowsocks-libev</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install shadowsocks-libev</span><br></pre></td></tr></table></figure>
<p>配置文件在 <strong>/etc/shadowsocks-libev/config.json</strong>，填写好服务器的配置</p>
<h4 id="配置登陆时自动启动"><a href="#配置登陆时自动启动" class="headerlink" title="配置登陆时自动启动"></a>配置登陆时自动启动</h4><p>在 <strong>/etc/rc.local</strong> 后面 <strong>exit 0</strong> 前面添加一行：（会把日志文件输出到pi用户的用户根目录的ss.log）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su pi -c &quot;nohup ss-local &gt; /home/pi/ss.log 2&gt;&amp;1 &amp;&quot;</span><br></pre></td></tr></table></figure></p>
<h4 id="安装-privoxy"><a href="#安装-privoxy" class="headerlink" title="安装 privoxy"></a>安装 privoxy</h4><p>现在虽然shadowsocks已经能够自动启动了，但是ss-local使用的是socks5代理，http协议是不能用它来代理的，所以需要一个名为privoxy的软件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install privoxy</span><br></pre></td></tr></table></figure></p>
<h4 id="配置-privoxy-全局代理"><a href="#配置-privoxy-全局代理" class="headerlink" title="配置 privoxy 全局代理"></a>配置 privoxy 全局代理</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/privoxy/whitelist.action</span><br></pre></td></tr></table></figure>
<p>写入以下内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;alias&#125;&#125;</span><br><span class="line"># 代理(socks5)</span><br><span class="line">socks5 = +forward-override&#123;forward-socks5 127.0.0.1:1080 .&#125;</span><br><span class="line"># 直连</span><br><span class="line">direct = +forward-override&#123;forward .&#125;</span><br><span class="line"></span><br><span class="line"># 所有网站走代理</span><br><span class="line">&#123;socks5&#125;</span><br><span class="line">/</span><br><span class="line"># 以下网站走直连</span><br><span class="line">&#123;direct&#125;</span><br><span class="line">.ip.cn</span><br><span class="line">.chinaz.com</span><br></pre></td></tr></table></figure></p>
<p><strong>其中端口号要与ss-local一致，这里我使用了1080端口</strong><br>然后把 <strong>actionsfile whitelist.action</strong> 添加到 <strong>/etc/privoxy/config</strong> 的末尾就完成了配置<br>最后重启privoxy并设置开机自启，看一下是否启动成功：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable privoxy</span><br><span class="line">sudo systemctl start privoxy</span><br><span class="line">sudo systemctl status privoxy</span><br></pre></td></tr></table></figure></p>
<p>目前，只要配置了 <strong>http_proxy</strong> 和 <strong>https_proxy</strong> 环境变量就能使用代理了，但是一旦配置了这个环境变量，所有的请求都会代理，如果希望选择性的代理，可以使用 gfwlist 实现 pac 模式，关于这点，我并没有过多的了解。</p>
<h4 id="编写-proxy-脚本实现自由代理"><a href="#编写-proxy-脚本实现自由代理" class="headerlink" title="编写 proxy 脚本实现自由代理"></a>编写 proxy 脚本实现自由代理</h4><p>所谓自由代理就是希望代理的时候通过在命令前加上 proxy 关键字进行代理访问，不需要代理的请求不加这个关键字就行了，无需其他配置。建议把脚本放在 <strong>/usr/local/bin/proxy</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /usr/local/bin/proxy</span><br></pre></td></tr></table></figure></p>
<p>写入以下内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">http_proxy=http://127.0.0.1:8118 https_proxy=http://127.0.0.1:8118 $*</span><br></pre></td></tr></table></figure></p>
<p><strong>其中端口号要与 privoxy 的配置一致，默认是8118</strong><br>然后赋予可执行权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/proxy</span><br></pre></td></tr></table></figure></p>
<p>至此，所有配置完成，重启后，需要代理的命令使用proxy前缀，比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo proxy apt install git</span><br></pre></td></tr></table></figure></p>
<h2 id="修改默认交换文件的大小"><a href="#修改默认交换文件的大小" class="headerlink" title="修改默认交换文件的大小"></a>修改默认交换文件的大小</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/dphys-swapfile</span><br></pre></td></tr></table></figure>
<p>修改其中的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONF_SWAPSIZE=100</span><br></pre></td></tr></table></figure></p>
<p>为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONF_SWAPSIZE=2048</span><br></pre></td></tr></table></figure></p>
<p>就有2G的虚拟内存，应该够用了，最后执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dphys-swapfile setup</span><br><span class="line">sudo dphys-swapfile swapon</span><br></pre></td></tr></table></figure></p>
<p>重新加载一下配置文件，然后就可以用 free 命令查看到 2G 虚拟内存了</p>
<h2 id="让-shell-界面有颜色"><a href="#让-shell-界面有颜色" class="headerlink" title="让 shell 界面有颜色"></a>让 shell 界面有颜色</h2><p>pi用户的shell界面默认是有颜色的，但是root用户默认没有，只要把pi用户的.bashrc文件中对应的部分复制到root用户的.bashrc中就可以达到目的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">case &quot;$TERM&quot; in</span><br><span class="line">    xterm-color|*-256color) color_prompt=yes;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">force_color_prompt=yes</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$force_color_prompt&quot; ]; then</span><br><span class="line">    if [ -x /usr/bin/tput ] &amp;&amp; tput setaf 1 &gt;&amp;/dev/null; then</span><br><span class="line">	color_prompt=yes</span><br><span class="line">    else</span><br><span class="line">	color_prompt=</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ &quot;$color_prompt&quot; = yes ]; then</span><br><span class="line">    PS1=&apos;$&#123;debian_chroot:+($debian_chroot)&#125;\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w \$\[\033[00m\] &apos;</span><br><span class="line">else</span><br><span class="line">    PS1=&apos;$&#123;debian_chroot:+($debian_chroot)&#125;\u@\h:\w\$ &apos;</span><br><span class="line">fi</span><br><span class="line">unset color_prompt force_color_prompt</span><br><span class="line"></span><br><span class="line">case &quot;$TERM&quot; in</span><br><span class="line">xterm*|rxvt*)</span><br><span class="line">    PS1=&quot;\[\e]0;$&#123;debian_chroot:+($debian_chroot)&#125;\u@\h: \w\a\]$PS1&quot;</span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">if [ -x /usr/bin/dircolors ]; then</span><br><span class="line">    test -r ~/.dircolors &amp;&amp; eval &quot;$(dircolors -b ~/.dircolors)&quot; || eval &quot;$(dircolors -b)&quot;</span><br><span class="line">    alias ls=&apos;ls --color=auto&apos;</span><br><span class="line">    alias grep=&apos;grep --color=auto&apos;</span><br><span class="line">    alias fgrep=&apos;fgrep --color=auto&apos;</span><br><span class="line">    alias egrep=&apos;egrep --color=auto&apos;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">alias ll=&apos;ls -al&apos;</span><br></pre></td></tr></table></figure></p>
<p>最后一句 alias 是把 ll 变成 ls -al 的别名，方便查看文件</p>
<h2 id="安装-apache2-php7-mysql-phpmyadmin"><a href="#安装-apache2-php7-mysql-phpmyadmin" class="headerlink" title="安装 apache2 + php7 + mysql + phpmyadmin"></a>安装 apache2 + php7 + mysql + phpmyadmin</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install apache2</span><br><span class="line">sudo apt install mysql-server mysql-client</span><br><span class="line">sudo apt install php php-mysql</span><br></pre></td></tr></table></figure>
<h3 id="mysql创建最高权限用户"><a href="#mysql创建最高权限用户" class="headerlink" title="mysql创建最高权限用户"></a>mysql创建最高权限用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO admin@localhost IDENTIFIED BY &apos;password&apos; WITH GRANT OPTION;</span><br></pre></td></tr></table></figure>
<h3 id="安装phpmyadmin"><a href="#安装phpmyadmin" class="headerlink" title="安装phpmyadmin"></a>安装phpmyadmin</h3><p>以phpMyAdmin-4.8.0.1为例（我修改了apache2的默认配置，网站根目录在 <strong>/var/www</strong>）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /opt/phpmyadmin</span><br><span class="line">cd /opt/phpmyadmin</span><br><span class="line">sudo curl -O https://files.phpmyadmin.net/phpMyAdmin/4.8.0.1/phpMyAdmin-4.8.0.1-all-languages.zip</span><br><span class="line">sudo unzip phpMyAdmin-4.8.0.1-all-languages.zip</span><br><span class="line">sudo ln -s /opt/phpmyadmin/phpMyAdmin-4.8.0.1-all-languages /var/www/phpmyadmin</span><br><span class="line">sudo cp /var/www/phpmyadmin/config.sample.inc.php /var/www/phpmyadmin/config.inc.php</span><br><span class="line">sudo mkdir /var/www/phpmyadmin/tmp</span><br><span class="line">sudo chown www-data -R /var/www/phpmyadmin/tmp</span><br><span class="line">sudo chgrp www-data -R /var/www/phpmyadmin/tmp</span><br></pre></td></tr></table></figure></p>
<h3 id="安装tomcat"><a href="#安装tomcat" class="headerlink" title="安装tomcat"></a>安装tomcat</h3><h4 id="创建tomcat用户和组"><a href="#创建tomcat用户和组" class="headerlink" title="创建tomcat用户和组"></a>创建tomcat用户和组</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd tomcat</span><br><span class="line">sudo useradd  -s  /bin/false  -g  tomcat  -d  /opt/tomcat tomcat</span><br></pre></td></tr></table></figure>
<h4 id="以9-0-7版本为例下载源码并配置"><a href="#以9-0-7版本为例下载源码并配置" class="headerlink" title="以9.0.7版本为例下载源码并配置"></a>以9.0.7版本为例下载源码并配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /opt/tomcat</span><br><span class="line">cd /opt/tomcat</span><br><span class="line">sudo curl -O http://mirrors.shu.edu.cn/apache/tomcat/tomcat-9/v9.0.7/bin/apache-tomcat-9.0.7.zip</span><br><span class="line">sudo unzip apache-tomcat-9.0.7.zip</span><br><span class="line">sudo mv -R apache-tomcat-9.0.7 9.0.7</span><br><span class="line">sudo ln -s /opt/tomcat/9.0.7 /opt/tomcat/latest</span><br><span class="line"># 修改权限</span><br><span class="line">sudo chown tomcat -R 9.0.7</span><br><span class="line">sudo chgrp tomcat -R 9.0.7</span><br><span class="line">sudo chmod 744 -R /opt/tomcat/latest/bin/*.sh</span><br></pre></td></tr></table></figure>
<h4 id="配置开机启动"><a href="#配置开机启动" class="headerlink" title="配置开机启动"></a>配置开机启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-java-alternatives  -l</span><br></pre></td></tr></table></figure>
<p>记下jdk路径（RASPBIAN系统+openjdk的sdk位置默认是 <strong>/usr/lib/jvm/java-1.8.0-openjdk-armhf</strong>）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/systemd/system/tomcat.service</span><br></pre></td></tr></table></figure></p>
<p>写入以下内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Apache Tomcat Web Application Container</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">Environment=JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-armhf/jre</span><br><span class="line">Environment=CATALINA_PID=/opt/tomcat/latest/temp/tomcat.pid</span><br><span class="line">Environment=CATALINA_HOME=/opt/tomcat/latest</span><br><span class="line">Environment=CATALINA_BASE=/opt/tomcat/latest</span><br><span class="line">Environment=&apos;CATALINA_OPTS=-Xms512M -Xmx1024M -server -XX:+UseParallelGC&apos;</span><br><span class="line">Environment=&apos;JAVA_OPTS=-Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom&apos;</span><br><span class="line">ExecStart=/opt/tomcat/latest/bin/startup.sh</span><br><span class="line">ExecStop=/opt/tomcat/latest/bin/shutdown.sh</span><br><span class="line">User=tomcat</span><br><span class="line">Group=tomcat</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></p>
<p>注意替换jdk位置，以及其后的jre不能遗漏，内存配置按需修改<br>重新加载systemctl、配置开机启动、启动tomcat以及查看是否成功启动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable tomcat</span><br><span class="line">sudo systemctl start tomcat</span><br><span class="line">sudo systemctl status tomcat</span><br></pre></td></tr></table></figure></p>
<h4 id="配置tomcat-web管理接口"><a href="#配置tomcat-web管理接口" class="headerlink" title="配置tomcat web管理接口"></a>配置tomcat web管理接口</h4><p>修改：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /opt/tomcat/latest/conf/tomcat-users.xml</span><br></pre></td></tr></table></figure></p>
<p>在tomcat-users中添加一行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;user username=&quot;tomcat&quot; password=&quot;password&quot; roles=&quot;manager-gui,admin-gui&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>修改META-INF权限配置，需要修改以下两个文件，允许局域网访问<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /opt/tomcat/latest/webapps/manager/META-INF/context.xml</span><br><span class="line">sudo nano /opt/tomcat/latest/webapps/host-manager/META-INF/context.xml</span><br></pre></td></tr></table></figure></p>
<p>两个文件中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Context antiResourceLocking=&quot;false&quot; privileged=&quot;true&quot; &gt;</span><br><span class="line">  &lt;Valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span><br><span class="line">         allow=&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot; /&gt;</span><br><span class="line">  &lt;Manager sessionAttributeValueClassNameFilter=&quot;java\.lang\.(?:Boolean|Integer|Long|Number|String)|org\.apache\.catalina\.filters\.CsrfPreventionFilter\$LruCache(?:\$1)?|java\.util\.(?:Linked)?HashMap&quot;/&gt;</span><br><span class="line">&lt;/Context&gt;</span><br></pre></td></tr></table></figure></p>
<p>都需要把<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow=&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot;</span><br></pre></td></tr></table></figure></p>
<p>修改为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow=&quot;127\.\d+\.\d+\.\d+|192\.168\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot;</span><br></pre></td></tr></table></figure></p>
<p>即允许来自192.168.开头的IP的访问，这样就可以通过局域网管理web应用了<br>最终文件长这个样子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Context antiResourceLocking=&quot;false&quot; privileged=&quot;true&quot; &gt;</span><br><span class="line">  &lt;Valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span><br><span class="line">         allow=&quot;127\.\d+\.\d+\.\d+|192\.168\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot; /&gt;</span><br><span class="line">  &lt;Manager sessionAttributeValueClassNameFilter=&quot;java\.lang\.(?:Boolean|Integer|Long|Number|String)|org\.apache\.catalina\.filters\.CsrfPreventionFilter\$LruCache(?:\$1)?|java\.util\.(?:Linked)?HashMap&quot;/&gt;</span><br><span class="line">&lt;/Context&gt;</span><br></pre></td></tr></table></figure></p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/树莓派/" rel="tag"># 树莓派</a>
          
            <a href="/tags/Debian/" rel="tag"># Debian</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/21/SpringMVC学习心得/" rel="next" title="SpringMVC学习心得">
                <i class="fa fa-chevron-left"></i> SpringMVC学习心得
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/12/RecyclerView探幽 - Adapter、ViewHolder、ItemList/" rel="prev" title="RecyclerView探幽 - Adapter、ViewHolder、ItemList">
                RecyclerView探幽 - Adapter、ViewHolder、ItemList <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="xinsane" />
            
              <p class="site-author-name" itemprop="name">xinsane</p>
              <p class="site-description motion-element" itemprop="description">走自己的路，我无所谓</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/x-insane" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:yanxuliu1997@163.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#引言"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装系统"><span class="nav-number">2.</span> <span class="nav-text">安装系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开启ssh"><span class="nav-number">3.</span> <span class="nav-text">开启ssh</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#禁止密码登陆ssh"><span class="nav-number">3.1.</span> <span class="nav-text">禁止密码登陆ssh</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#换源-or-代理？"><span class="nav-number">4.</span> <span class="nav-text">换源 or 代理？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-shadowsocks-libev-privoxy-实现自由命令行代理"><span class="nav-number">4.1.</span> <span class="nav-text">使用 shadowsocks-libev + privoxy 实现自由命令行代理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装-shadowsocks-libev"><span class="nav-number">4.1.1.</span> <span class="nav-text">安装 shadowsocks-libev</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置登陆时自动启动"><span class="nav-number">4.1.2.</span> <span class="nav-text">配置登陆时自动启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装-privoxy"><span class="nav-number">4.1.3.</span> <span class="nav-text">安装 privoxy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置-privoxy-全局代理"><span class="nav-number">4.1.4.</span> <span class="nav-text">配置 privoxy 全局代理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写-proxy-脚本实现自由代理"><span class="nav-number">4.1.5.</span> <span class="nav-text">编写 proxy 脚本实现自由代理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改默认交换文件的大小"><span class="nav-number">5.</span> <span class="nav-text">修改默认交换文件的大小</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#让-shell-界面有颜色"><span class="nav-number">6.</span> <span class="nav-text">让 shell 界面有颜色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-apache2-php7-mysql-phpmyadmin"><span class="nav-number">7.</span> <span class="nav-text">安装 apache2 + php7 + mysql + phpmyadmin</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mysql创建最高权限用户"><span class="nav-number">7.1.</span> <span class="nav-text">mysql创建最高权限用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装phpmyadmin"><span class="nav-number">7.2.</span> <span class="nav-text">安装phpmyadmin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装tomcat"><span class="nav-number">7.3.</span> <span class="nav-text">安装tomcat</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建tomcat用户和组"><span class="nav-number">7.3.1.</span> <span class="nav-text">创建tomcat用户和组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#以9-0-7版本为例下载源码并配置"><span class="nav-number">7.3.2.</span> <span class="nav-text">以9.0.7版本为例下载源码并配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置开机启动"><span class="nav-number">7.3.3.</span> <span class="nav-text">配置开机启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置tomcat-web管理接口"><span class="nav-number">7.3.4.</span> <span class="nav-text">配置tomcat web管理接口</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xinsane</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.1.0"></script>



  



	





  





  










  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("P8rP2sSuQRlDoBjlxIV1Iyfo-gzGzoHsz", "xAUwdTiwAkOvVDzcQxaClXnq");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text(counter.get('time'));
            
            counter.save(null, {
              success: function(counter) {
                
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text('Counter not initialized! See more at console err msg.');
              console.error('ATTENTION! LeanCloud counter has security bug, see here how to solve it: https://github.com/theme-next/hexo-leancloud-counter-security. \n But you also can use LeanCloud without security, by set \'security\' option to \'false\'.');
            
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  
  

  

  

  

  

</body>
</html>
